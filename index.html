<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Mapbox Project</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.js"></script>
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.css" rel="stylesheet"/>
    <script src="./bootstrap.js"></script>
    <link href="./bootstrap.css" rel="stylesheet"/>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Assistant&display=swap" rel="stylesheet"/>
    <link href="./mapstyles.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>
  </head>
  <script>

    var forms = [
      'Gagon_Addicts',
      'Gagon_Women',
      'Transition Apartment',
      "Hygiene Center",
      "The Platform",
      "Issa",
      "Dirty Burger",
      "Synagogue Beit El",
      "Mati",
      "Natan",
      "Dizengoff  Square",
      "Yechezkel",
      "Pasta Basta",
      "dizengoff Bottles",
      "market",
      "only_text"
    ]

    var formIdx = {
      '"Lasova"_Gagon_Addicts': 0,
      '"Lasova"_Gagon_Women': 1,
      '"Lasova"_Transition Apartment': 2,
      "Hygiene Center": 3,
      "The Platform": 4,
      "Issa": 5,
      "Dirty Burger": 6,
      "Synagogue Beit El": 7,
      "Mati": 8,
      "Natan": 9,
      "Dizengoff  Square": 10,
      "Yechezkel": 11,
      "Pasta Basta": 12,
      "dizengoff Bottles": 13,
      "market": 14,
      "only_text": 15
    }

    var sources = {
      "Dizengoff  Square_in": "Dizengoff Setion.pdf",
      "Dizengoff  Square_in2": "Zoom-in Section.pdf"
    }
        
    var layers = [];
    function openForm(idx) {
      for (i = 0; i < forms.length; i++) {
        if (i == idx) {
          // console.log(forms[i]);
          document.getElementById(forms[i]).style.display = "block";
        }
        else {
          document.getElementById(forms[i]).style.display = "none";
        }
      }
    }

    function openImage(id) {
      // console.log('here: ' + id);
      document.getElementById(id).style.display = "block";
      closeForm();
    }

    function closeImage(id1, id2) {
      document.getElementById(id1).style.display = "none";
      openForm(formIdx[id2]);
    }

    function closeForm() {
      for (i = 0; i < forms.length; i++)
      {
        document.getElementById(forms[i]).style.display = "none";
      }
    }

    var relIdx = 0;
    function changeSource(id1, id2) {
      // console.log('onchange: ' + id1 + ', ' + id2);
      document.getElementById(id2).style.display = "block";
      document.getElementById(id1).style.display = "none";
    }

    function accordionClick() {
      var vis = map.getLayer('3D').visibility;
      var isChecked = false;
      if (vis == 'visible')
        isChecked = true;
      for (i = 0; i < collapseOne.children.length; i++) {
        if (collapseOne.children[i].innerText == '3D') {
          collapseOne.children[i].children[0].checked = isChecked;
        }
      }
    }

    var individual_layers = [
      '3D',
      'city-border',
      'light-rail',
      'metro',
      'kibbutz-nadavot',
      'collecting-bottles', 
      'drug-deals',
      'formal',
      'stay-points-exist',
      'green areas and parks',
      'food-exist',
      'stay-points-exist',
      'green areas and parks'
    ];

    var titlesHebrew = {
      'מחקר': 'research',
      'תכנון': 'planning'
    }

    var researchOn = true;
    var planningOn = false;

    function setLayerVis(current_layer, e) {
      const clickedLayer = current_layer.textContent;
      if (e != null) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      const visibility = map.getLayoutProperty(
        clickedLayer,
        'visibility'
      );
      if (visibility == 'visible' && current_layer.checked == false) {
          map.setLayoutProperty(clickedLayer, 'visibility', 'none');
          this.className = '';
      } else {
        this.className = 'active';
        map.setLayoutProperty(
          clickedLayer,
          'visibility',
          'visible'
        );
      }
    }


    function clickTitle(titleName) {
      var mainTitle = document.getElementById('main_title').children[0];
      var secondaryTitle = document.getElementById('secondary_title');
      var instructionTitle= document.getElementById('instruction');
      var accordionDiv = document.getElementById(titlesHebrew[titleName]);
      var clickedItem = document.getElementById(titleName);
      if (titleName == "מחקר") {
        researchOn = !researchOn;
        if (!planningOn) {
          mainTitle.innerHTML = 'כלי לקריאה מחודשת של תל-אביב מעיניהם של דרי הרחוב';
          secondaryTitle.style.display = 'block';
          instructionTitle.style.display = 'none';
        }
      }
      else if (titleName == "תכנון") {
        planningOn = !planningOn;
        mainTitle.innerHTML = 'פריסת מוקדים עירונית המאפשרת קיום חיים בסטטוס המעבר';
        secondaryTitle.style.display = 'none';
        instructionTitle.style.display = 'block';
        var vis = true;
        if (!planningOn && !researchOn) {
          vis = false;
        }
        if (!planningOn && researchOn) {
          mainTitle.innerHTML = 'כלי לקריאה מחודשת של תל-אביב מעיניהם של דרי הרחוב';
          secondaryTitle.style.display = 'block';
          instructionTitle.style.display = 'none';
        }
        for (i = 0; i < research.children.length; i++) {
          var current_line = research.children[i];
          
          if (current_line.id.startsWith('accordion')) {
            var subTitleCheckBox = current_line.children[0].children[0].children[0].children[0];
            subTitleCheckBox.checked = vis;
            var current_subtitle = current_line.children[0].children[1];
            for (j = 0; j < current_subtitle.children.length; j++){
              const current_layer = current_subtitle.children[j].children[0];
              if (individual_layers.includes(current_layer.id)) {
                current_layer.checked = vis;
                if (current_layer.id.endsWith("_" + titleName))
                  continue;
                setLayerVis(current_layer, null);
              }
            }
          }
          else {
            const current_layer = current_line.children[0];
          
            if (individual_layers.includes(current_layer.id)) {
              current_layer.checked = vis;
              if (current_layer.id.endsWith("_" + titleName))
                continue;
              setLayerVis(current_layer, null);
            }
          }
          
        }
      }
      for (i = 0; i < accordionDiv.children.length; i++)
      {
        var current_line = accordionDiv.children[i];
        if (current_line.id.startsWith('accordion')) {
          var subTitleCheckBox = current_line.children[0].children[0].children[0].children[0];
          subTitleCheckBox.checked = clickedItem.checked;
          var current_subtitle = current_line.children[0].children[1];
          for (j = 0; j < current_subtitle.children.length; j++){
            const current_layer = current_subtitle.children[j].children[0];
            if (current_layer.id == "3D")
              continue;
            if (clickedItem.checked == false) {
              if (!individual_layers.includes(current_layer.id) || (!researchOn && !planningOn))
                current_layer.checked = false;
            } else {
              if (!individual_layers.includes(current_layer.id) || (researchOn || planningOn))
                current_layer.checked = true;
            }
            setLayerVis(current_layer, null);
          }
        }
        else {
          const current_layer = current_line.children[0];
        
          if (current_layer.id == "3D")
              continue;
          if (clickedItem.checked == false) {
            if (!individual_layers.includes(current_layer.id) || (!researchOn && !planningOn))
              current_layer.checked = false;
          } else {
            if (!individual_layers.includes(current_layer.id) || (researchOn || planningOn))
              current_layer.checked = true;
          }
          setLayerVis(current_layer, null);
        }
      }
    }


  </script>
  <div class="map-title" id="main_title">
    <h1 style="padding-top: 5px; padding-right: 8px; padding-left: 8px; text-align: center;">כלי לקריאה מחודשת של תל-אביב מעיניהם של דרי הרחוב</h1>
  </div>
  <div class="secondary-title" id="secondary_title">
    <p style="padding-right: 2px; padding-left: 2px; text-align: right;">לחץ על הנקודות הצהובות להכרת הסיפורים האישיים
      לחץ על הנקודות האדומות בכיכר דיזינגוף \ שוק הכרמל להעמקת מקטע אזורי</p>
  </div>
  <div class="instruction-title" id="instruction" style="display: none;">
    <p style="padding-right: 2px; padding-left: 2px; text-align: right;">לחץ כאן לליווי דר רחוב ביומו בפריסה העירונית</p>
  </div>
  <body>
    <div id="map"></div>
    <div class="map-overlay">
      <div class="accordion" id="accordion">
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingOne">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne" onclick='accordionClick()'>
              מקרא
            </button>
          </h2>
          <div id="collapseOne" class="accordion-collapse collapse hide" aria-labelledby="headingOne1">
            <div class="accordion" id="accordion1">
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingOne1">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#research" aria-expanded="true" aria-controls="research" onclick='accordionClick()'>
                    <input type="checkbox" checked id="מחקר" href="#" class="active" onchange="clickTitle('מחקר')"></input>
                    <span style="padding-inline: 10px;">מחקר</span>
                  </button>
                </h2>
                <div id="research" class="accordion-collapse collapse hide" aria-labelledby="headingOne1" data-parent="#collapseOne"></div>
              </div>
            </div>
            <div class="accordion" id="accordion2">
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingOne2">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#planning" aria-expanded="true" aria-controls="planning" onclick='accordionClick()'>
                    <input type="checkbox" id="תכנון" href="#" class="active" onchange="clickTitle('תכנון')"></input>
                    <span style="padding-inline: 10px;">תכנון</span>
                  </button>
                </h2>
                <div id="planning" class="accordion-collapse collapse hide" aria-labelledby="headingOne2" data-parent="#collapseOne"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
    </div>
    <div class="full-image" id="Mechurim">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeImage("Mechurim", "\"Lasova\"_Gagon_Addicts")'>x</button>
      <div id="Mechurim_in"></div>
      <script src="https://documentcloud.adobe.com/view-sdk/main.js"></script>
      <script type="text/javascript">
        document.addEventListener("adobe_dc_view_sdk.ready", function(){ 
          var adobeDCView = new AdobeDC.View({clientId: "9029a3f828a14ab9b10c9b799a7981d8", divId: "Mechurim_in"});
          adobeDCView.previewFile({
            content:{location: {url: "https://studio-project-mid.github.io/mapbox/images/Mechurim.pdf"}},
            metaData:{fileName: "פרטים גגון מכורים"}
          }, {embedMode: "SIZED_CONTAINER", showDownloadPDF: false, showPrintPDF: false});
        });
      </script>
    </div>
    <div class="full-image" id="Women">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeImage("Women", "\"Lasova\"_Gagon_Women")'>x</button>
      <div id="Women_in"></div>
      <script src="https://documentcloud.adobe.com/view-sdk/main.js"></script>
      <script type="text/javascript">
        document.addEventListener("adobe_dc_view_sdk.ready", function(){ 
          var adobeDCView = new AdobeDC.View({clientId: "9029a3f828a14ab9b10c9b799a7981d8", divId: "Women_in"});
          adobeDCView.previewFile({
            content:{location: {url: "https://studio-project-mid.github.io/mapbox/images/Women.pdf"}},
            metaData:{fileName: "פרטים גגון נשים"}
          }, {embedMode: "SIZED_CONTAINER", showDownloadPDF: false, showPrintPDF: false});
        });
      </script>
    </div>
    <div class="full-image" id="Dirat Maavar">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeImage("Dirat Maavar", "\"Lasova\"_Transition Apartment")'>x</button>
      <div id="Dirat Maavar_in"></div>
      <script src="https://documentcloud.adobe.com/view-sdk/main.js"></script>
      <script type="text/javascript">
        document.addEventListener("adobe_dc_view_sdk.ready", function(){ 
          var adobeDCView = new AdobeDC.View({clientId: "9029a3f828a14ab9b10c9b799a7981d8", divId: "Dirat Maavar_in"});
          adobeDCView.previewFile({
            content:{location: {url: "https://studio-project-mid.github.io/mapbox/images/Dirat Maavar.pdf"}},
            metaData:{fileName: "פרטים דירת מעבר"}
          }, {embedMode: "SIZED_CONTAINER", showDownloadPDF: false, showPrintPDF: false});
        });
      </script>
    </div>
   
    <div class="full-image" id="Dirty Burger img">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeImage("Dirty Burger img", "Dirty Burger")'>x</button>
      <div id="Dirty Burger img_in"></div>
      <script src="https://documentcloud.adobe.com/view-sdk/main.js"></script>
      <script type="text/javascript">
        document.addEventListener("adobe_dc_view_sdk.ready", function(){ 
          var adobeDCView = new AdobeDC.View({clientId: "9029a3f828a14ab9b10c9b799a7981d8", divId: "Dirty Burger img_in"});
          adobeDCView.previewFile({
            content:{location: {url: "https://studio-project-mid.github.io/mapbox/images/Dirty Burger.pdf"}},
            metaData:{fileName: '"המלוכלך"'}
          }, {embedMode: "SIZED_CONTAINER", showDownloadPDF: false, showPrintPDF: false});
        });
      </script>
    </div>
    <!-- https://drive.google.com/file/d/1FodN9dEg-fYmh659HAUIrqG4MjcNJV0O/preview -->
    <div class="full-image" id="Frishman 46">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeImage("Frishman 46", "Natan")'>x</button>

      <div id="Frishman 46_in"></div>
      <script src="https://documentcloud.adobe.com/view-sdk/main.js"></script>
      <script type="text/javascript">
        document.addEventListener("adobe_dc_view_sdk.ready", function(){ 
          var adobeDCView = new AdobeDC.View({clientId: "9029a3f828a14ab9b10c9b799a7981d8", divId: "Frishman 46_in"});
          adobeDCView.previewFile({
            content:{location: {url: "https://studio-project-mid.github.io/mapbox/images/Frishman 46.pdf"}},
            metaData:{fileName: "ספסל מול מגדל פרישמן"}
          }, {embedMode: "SIZED_CONTAINER", showDownloadPDF: false, showPrintPDF: false});
        });
      </script>
    </div>
    <div class="full-image" id="Dizengoff  Square_in">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeImage("Dizengoff  Square_in", "Dizengoff  Square")'>x</button>
      <button class="button" onclick="changeSource('Dizengoff  Square_in', 'Dizengoff  Square_in2')"><div class="button__arrow button__arrow--left"></div></button>
      <div id="Dizengoff  Square_in_in"></div>
      <script src="https://documentcloud.adobe.com/view-sdk/main.js"></script>
      <script type="text/javascript">
        document.addEventListener("adobe_dc_view_sdk.ready", function(){ 
          var adobeDCView = new AdobeDC.View({clientId: "9029a3f828a14ab9b10c9b799a7981d8", divId: "Dizengoff  Square_in_in"});
          adobeDCView.previewFile({
            content:{location: {url: "https://studio-project-mid.github.io/mapbox/images/Dizengoff Setion.pdf"}},
            metaData:{fileName: "מקטע דיזינגוף"}
          }, {embedMode: "SIZED_CONTAINER", showDownloadPDF: false, showPrintPDF: false});
        });
      </script>
    </div>
   
    <div class="full-image" id="Dizengoff  Square_in2">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeImage("Dizengoff  Square_in2", "Dizengoff  Square")'>x</button>
      <button class="button" onclick="changeSource('Dizengoff  Square_in2', 'Dizengoff  Square_in')"><div class="button__arrow button__arrow--left"></div></button>
      <div id="Dizengoff  Square_in2_in"></div>
      <script src="https://documentcloud.adobe.com/view-sdk/main.js"></script>
      <script type="text/javascript">
        document.addEventListener("adobe_dc_view_sdk.ready", function(){ 
          var adobeDCView = new AdobeDC.View({clientId: "9029a3f828a14ab9b10c9b799a7981d8", divId: "Dizengoff  Square_in2_in"});
          adobeDCView.previewFile({
            content:{location: {url: "https://studio-project-mid.github.io/mapbox/images/Zoom-in Section.pdf"}},
            metaData:{fileName: "שימושי מקטע דיזינגוף"}
          }, {embedMode: "SIZED_CONTAINER", showDownloadPDF: false, showPrintPDF: false});
        });
      </script>
    </div>
    <div class="full-image" id="market_in">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeImage("market_in", "market")'>x</button>
      <button class="button" onclick="changeSource('market_in', 'market_in2')"><div class="button__arrow button__arrow--left"></div></button>
      <div id="market_in_in"></div>
      <script src="https://documentcloud.adobe.com/view-sdk/main.js"></script>
      <script type="text/javascript">
        document.addEventListener("adobe_dc_view_sdk.ready", function(){ 
          var adobeDCView = new AdobeDC.View({clientId: "9029a3f828a14ab9b10c9b799a7981d8", divId: "market_in_in"});
          adobeDCView.previewFile({
            content:{location: {url: "https://studio-project-mid.github.io/mapbox/images/Market Section.pdf"}},
            metaData:{fileName: "מקטע שוק הכרמל"}
          }, {embedMode: "SIZED_CONTAINER", showDownloadPDF: false, showPrintPDF: false});
        });
      </script>
    </div>
    <div class="full-image" id="market_in2">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeImage("market_in2", "market")'>x</button>
      <button class="button" onclick="changeSource('market_in2', 'market_in')"><div class="button__arrow button__arrow--left"></div></button>
      <embed
        id="market_in2_in"
        height="100%"
        width="100%" 
        src="images/Zoom-in-Section_GIF.gif#view=Fit">
      </embed>
      
    </div>

    <div class="full-image" id="Dizengoff  Square_in">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeImage("Dizengoff  Square_in", "Dizengoff  Square")'>x</button>
      <button class="button" onclick="changeSource('Dizengoff  Square_in', 'Dizengoff  Square_in2')"><div class="button__arrow button__arrow--left"></div></button>
      <div id="Dizengoff  Square_in_in"></div>
      <script src="https://documentcloud.adobe.com/view-sdk/main.js"></script>
      <script type="text/javascript">
        document.addEventListener("adobe_dc_view_sdk.ready", function(){ 
          var adobeDCView = new AdobeDC.View({clientId: "9029a3f828a14ab9b10c9b799a7981d8", divId: "Dizengoff  Square_in_in"});
          adobeDCView.previewFile({
            content:{location: {url: "https://studio-project-mid.github.io/mapbox/images/Dizengoff Setion.pdf"}},
            metaData:{fileName: "מקטע דיזינגוף"}
          }, {embedMode: "SIZED_CONTAINER", showDownloadPDF: false, showPrintPDF: false});
        });
      </script>
    </div>

    <div class="form-popup" id="Gagon_Addicts">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeForm()'>x</button>
      <button type="button" class="btn btn-outline-secondary" id='enlarge' onclick='openImage("Mechurim")'>Enlarge</button>
      <form action="/action_page.php" class="form-container" id="text_form"></form>
      <embed
        height="100%"
        width="100%" 
        src="images/Mechurim.pdf">
      </embed>
    </div>
    <div class="form-popup" id="Gagon_Women">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeForm()'>x</button>
      <button type="button" class="btn btn-outline-secondary" id='enlarge' onclick='openImage("Women")'>Enlarge</button>
      <form action="/action_page.php" class="form-container" id="text_form"></form>
      <embed
        height="100%"
        width="100%" 
        src="images/Women.pdf">
      </embed>
    </div>
    <div class="form-popup" id="Transition Apartment">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeForm()'>x</button>
      <button type="button" class="btn btn-outline-secondary" id='enlarge' onclick='openImage("Dirat Maavar")'>Enlarge</button>
      <form action="/action_page.php" class="form-container" id="text_form"></form>
      <embed
        height="100%"
        width="100%" 
        src="images/Dirat Maavar.pdf">
      </embed>
    </div>
    <audio controls id="Hygiene Center">
      <source src="audio/חביב_מרכז היגיינה.m4a" type="audio/wav">
    </audio>
    <audio controls id="The Platform">
      <source src="audio/יואב_יחידת דרי רחוב.mp3" type="audio/mp3">
    </audio>
    <div class="form-popup" id="Issa">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeForm()'>x</button>
      <form action="/action_page.php" class="form-container" id="text_form"></form>
      <iframe 
      width="560" 
      height="315" 
      src="https://www.youtube.com/embed/VEznznkTYB4" 
      title="Natan" 
      frameborder="0" 
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
      allowfullscreen>
      </iframe>
    </div>
    <div class="form-popup" id="Dirty Burger">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeForm()'>x</button>
      <button type="button" class="btn btn-outline-secondary" id='enlarge' onclick='openImage("Dirty Burger img")'>Enlarge</button>
      <form action="/action_page.php" class="form-container" id="text_form"></form>
      <embed
        height="100%"
        width="100%" 
        src="images/Dirty Burger.pdf">
      </embed>
    </div>
    <form action="/action_page.php" class="text-container" id="Synagogue Beit El">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeForm()'>x</button>
      <p>״תשאלי אותי איפה אני אוכל בשבת, למרות שאני לא כל כך רעב בבוקר…חוף פרישמן קצת קרוב לבן יהודה יש בית כנסת של הקהילה הצרפתית…עכשיו, כל שבת אחרי שהם גומרים את התפילה הם עושים קידוש, עכשיו אני אוהב נורא חמין, אז כל שבת הם עושים בחצר אוכל, וזה מה שאני לוקח…״ (נתן, דר רחוב)
      </p>
    </form>

    <div class="form-popup" id="Mati">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeForm()'>x</button>
      <form action="/action_page.php" class="form-container" id="text_form"></form>
      <iframe 
      width="560" 
      height="315" 
      src="https://www.youtube.com/embed/DSquda0KJEA" 
      title="Mati" 
      frameborder="0" 
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
      allowfullscreen>
      </iframe>
    </div>
    <div class="form-popup" id="Natan">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeForm()'>x</button>
      <button type="button" class="btn btn-outline-secondary" id='enlarge' onclick='openImage("Frishman 46")'>Enlarge</button>
      <form action="/action_page.php" class="form-container" id="text_form"></form>
      <iframe 
      width="560" 
      height="315" 
      src="https://www.youtube.com/embed/24_9tw-MQAw"
      title="Natan" 
      frameborder="0" 
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
      allowfullscreen>
      </iframe>
      <embed
        height="100%"
        width="100%" 
        src="images/Frishman 46.pdf">
      </embed>
    </div>
    <div class="form-popup" id="Dizengoff  Square">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeForm()'>x</button>
      <button type="button" class="btn btn-outline-secondary" id='enlarge' onclick='openImage("Dizengoff  Square_in")'>Enlarge</button>
      <form action="/action_page.php" class="form-container" id="text_form"></form>
      <embed
        height="100%"
        width="100%" 
        src="images/Dizengoff Setion.pdf">
      </embed>
      <embed
        height="100%"
        width="100%" 
        src="images/Zoom-in Section.pdf">
      </embed>
    </div>
    <div class="form-popup" id="Yechezkel">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeForm()'>x</button>
      <form action="/action_page.php" class="form-container" id="text_form"></form>
      <iframe 
      width="560" 
      height="315" 
      src="https://www.youtube.com/embed/pv_3srpmluY" 
      title="Yechezkel" 
      frameborder="0" 
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
      allowfullscreen>
      </iframe>
    </div>
    <div class="form-popup" id="Pasta Basta" style="height: 390px;">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeForm()'>x</button>
      <form action="/action_page.php" class="form-container" id="text_form"></form>
      <iframe 
      width="560" 
      height="315" 
      src="https://www.youtube.com/embed/cfGCpt0K-ys" 
      title="Mati" 
      frameborder="0" 
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
      allowfullscreen>
      </iframe>
    </div>
    <div class="form-popup" id="dizengoff Bottles" style="height: 390px;">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeForm()'>x</button>
      <form action="/action_page.php" class="form-container" id="text_form"></form>
      <iframe 
      width="560" 
      height="315" 
      src="https://www.youtube.com/embed/urNfjpW-Cfg" 
      title="Mati" 
      frameborder="0" 
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
      allowfullscreen>
      </iframe>
    </div>
    <div class="form-popup" id="market">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeForm()'>x</button>
      <button type="button" class="btn btn-outline-secondary" id='enlarge' onclick='openImage("market_in")'>Enlarge</button>
      <form action="/action_page.php" class="form-container" id="text_form"></form>
      <embed
        height="100%"
        width="100%" 
        src="images/Market Section.pdf">
      </embed>
      <embed
        height="100%"
        width="100%" 
        src="images/Zoom-in-Section_GIF.gif">
      </embed>
    </div>
    <div class="form-popup" id="only_text" style="direction: rtl; text-align: right; width: 400px;">
      <button type="button" class="btn btn-outline-dark" id='close' onclick='closeForm()'>x</button>
      <form action="/action_page.php" class="form-container" id="text_form"></form>
    </div>
  
    <script>
      
      // function addLayersToMap(map) {
      //   map.addSource('parking_new_source', {
      //     'type': 'geojson',
      //     'data': 'json/parking_new.geojson'
      //   });
      //   map.addLayer(
      //     {
      //       'id': 'parking_new',
      //       'type': 'circle',
      //       'source': 'parking_new_source',
      //       'layout': {},
      //       'paint': {
      //         'circle-color': '#2ec1e5',
      //         'circle-opacity': 0.4,
      //         'circle-radius': 2
      //       }
      //     },
      //     'parking'
      //   );
      // }

      mapboxgl.accessToken = 'pk.eyJ1IjoiYWRpZ2FsaSIsImEiOiJja3dsc3ViOHYwMXNxMnBxdDRmOW1tcDRhIn0.01oFmibnj8b3erAu6aTXIg';
      mapboxgl.setRTLTextPlugin(
        'https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-rtl-text/v0.2.3/mapbox-gl-rtl-text.js',
        null,
        true 
      );

      var flying = false;
      var formToOpen = "";

      var draftMap = new mapboxgl.Map({
        container: 'map', 
        style: 'mapbox://styles/adigali/cl2vr1nwz003f14mzeyzvad26' 
      });

      var map = new mapboxgl.Map({
        container: 'map', 
        style: 'mapbox://styles/adigali/ckwluaunh2ymp14o5vwkekbgg' 
        
      });

      var pos = [34.77551, 32.07435];
      var isRouteOn = false;
      var routePopups = [];

      function closeAllImages(image_list) {
        for (i = 0; i < image_list.length; i++) {
          document.getElementById(image_list[i]).style.display = 'none';
        }
      }

      function getNextForm(imageId, image_list, index_dict) {
        return image_list[index_dict[imageId]];
      }

      function createFullImageSeries(imgId, nextForm, image_list) {
        var divItem = document.createElement('div');
        divItem.className = 'full-image';
        divItem.id = imgId;
        document.body.appendChild(divItem);
        // Close Button
        var closeButton = document.createElement('button');
        closeButton.type = 'button';
        closeButton.className = 'btn btn-outline-dark';
        closeButton.id = 'close_';
        closeButton.onclick = function(){closeAllImages(image_list);};
        closeButton.innerHTML = 'x';
        // Arrow
        var arrowButton = document.createElement('button');
        arrowButton.className = 'button';
        arrowButton.onclick = function() {changeSource(imgId, nextForm);};
        var innerButtonDiv = document.createElement('div');
        innerButtonDiv.className = 'button__arrow button__arrow--left';
        arrowButton.appendChild(innerButtonDiv);
        // Adobe
        var innerDiv = document.createElement('div');
        innerDiv.id = imgId + "_in";
        var firstScript = document.createElement('script');
        firstScript.src = "https://documentcloud.adobe.com/view-sdk/main.js";
        var secondScript = document.createElement('script');
        secondScript.type = "text/javascript";
        secondScript.innerHTML = "document.addEventListener(\"adobe_dc_view_sdk.ready\", function(){ " +
          "var adobeDCView = new AdobeDC.View({clientId: \"9029a3f828a14ab9b10c9b799a7981d8\", divId: \"" + innerDiv.id + "\"});" +
          "adobeDCView.previewFile({" +
            "content:{location: {url: \"https://studio-project-mid.github.io/mapbox/images/" + imgId + ".pdf\"}}," +
            "metaData:{fileName: \"" + imgId + "\"}" +
          "}, {embedMode: \"SIZED_CONTAINER\", showDownloadPDF: false, showPrintPDF: false});" +
        "});";
        divItem.appendChild(closeButton);
        divItem.appendChild(arrowButton);
        divItem.appendChild(innerDiv);
        divItem.appendChild(firstScript);
        divItem.appendChild(secondScript);
      }

      var klisher_images_list = ['01', '02', '03', '04', '05'];

      var binyamin_images_list = [
        '01_Building_Photo',
        '02_Explanation_of_the_point',
        '03_Context',
        '04_Ground_Plan',
        '05_First_floor_plan',
        '06_Second_floor_plan',
        '07_Magen_David_Section',
        '08_Circulation_diagram',
        '09_מבט',
        '10_מבט'
      ];

      for (i = 0; i < klisher_images_list.length; i++) {
        var imgId = klisher_images_list[i];
        var nextForm = i == klisher_images_list.length - 1 ? klisher_images_list[0] : klisher_images_list[i + 1];
        createFullImageSeries(imgId, nextForm, klisher_images_list);
      }
      for (i = 0; i < binyamin_images_list.length; i++) {
        var imgId = binyamin_images_list[i];
        var nextForm = i == binyamin_images_list.length - 1 ? binyamin_images_list[0] : binyamin_images_list[i + 1];
        createFullImageSeries(imgId, nextForm, binyamin_images_list);
      }

      map.on('load', function () {
        map.getCanvas().style.cursor = 'default';

        var draft_map_layers = draftMap.getStyle().layers;
        map.addSource('composite_new', draftMap.getStyle().sources['composite']);
        for (i = 75; i < draft_map_layers.length; i++) {
          draft_map_layers[i]['source'] += "_new";
          map.addLayer(
            draft_map_layers[i], 
            map.getStyle().layers[map.getStyle().layers.length - 1].id
          )
        }

        function setRouteVis(vis) {
          map.setLayoutProperty(
            '3d-route',
            'visibility',
            vis
          );
          map.setLayoutProperty(
            '24h-homeless-route',
            'visibility',
            vis
          );
        }

        function setTitlesVis(vis) {
          document.getElementById("main_title").style.display = vis;
          document.getElementById("secondary_title").style.display = vis;
          document.getElementById("instruction").style.display = vis;
        }

        // Turn off 3D layer
        map.setLayoutProperty(
            '3D',
            'visibility',
            'none'
        );
        // Turn off route layers
        setRouteVis('none');

        // map.setLayerZoomRange('3d-route', 0, 24);
        // map.setLayerZoomRange('24h-homeless-route', 0, 24);

        map.flyTo({
          
          center: pos,
          zoom: 13,
          bearing: 0,
          
          speed: 0.2, 
          curve: 1, 
          
          easing: (t) => t,
          
          essential: true
        });

        const nav = new mapboxgl.NavigationControl({
          visualizePitch: true
        });
        map.addControl(nav, 'top-right');
        document.querySelector('.mapboxgl-ctrl-compass').addEventListener('click', () =>{
          
          // Turn off 3D layer
          var layer_3d = document.getElementById('3D');
          layer_3d.checked = false;
          map.setLayoutProperty(
            '3D',
            'visibility',
            'none'
          );

          if (map.getLayoutProperty('3d-route', 'visibility') == 'visible') {
            // Turn off route
            setRouteVis('none');
            // Remove route popups
            while (routePopups.length > 0) {
              routePopups.pop().remove();
            }
            // Turn off route layers
            for (i = 0; i < route_layers.length; i++) {
              var idx = i;
              var current_box = document.getElementById(route_layers[i]);
              current_box.checked = false;
              var evt = document.createEvent("HTMLEvents");
              evt.initEvent("change", false, true);
              current_box.dispatchEvent(evt);
              i = idx;
            }
            // Turn on planning layers
            var planning_checkbox = document.getElementById('תכנון');
            planning_checkbox.checked = true;
            var evt = document.createEvent("HTMLEvents");
            evt.initEvent("change", false, true);
            planning_checkbox.dispatchEvent(evt);
            // Turn on map titles
            setTitlesVis("block");
            // Fly back up
            map.fire('flystart');
          }
          
          
          // Fly to initial position
          map.flyTo({
          center: map.getCenter(),
          zoom: 14,
          bearing: 0,
          pitch: 0,
          speed: 0.5,
          curve: 1,
          easing: (t) => t,
          essential: true
          });
        });

        var toCheck = true;

        var titlesHebrew = {
          'מחקר': 'research',
          'תכנון': 'planning'
        }
        
        var layers_for_legend = {
          'מחקר': {
            '3D': '3D',
            'city-border': 'גבול העיר',
            'light-rail': 'תוואי הרכבת הקלה',
            'metro': 'רכבת תחתית',
            'עבודה': {
              'kibbutz-nadavot': 'קיבוץ נדבות',
              'collecting-bottles': 'איסוף בקבוקים', 
              'drug-deals': 'עסקאות סמים' 
            },
            'formal': 'מוסדות פורמליים',
            'שהייה': {
              'stay-points-exist': 'נקודות שהייה שנחקרו',
              'green areas and parks': 'גינות'
            },
            'food-exist': 'מזון',
            'sleeping-corners': 'לינה',
            'parking': 'חניונים',
            'front yard and back yard': 'חצר קדמית ואחורית',
            'air-corridors': 'מסדרונות אוויר',
          },
          'תכנון': {
            'התרעננות': {
              'beaches-wardrobes': 'מלתחות חוף',
              'mikvahs': 'מקוואות',
              'sport': 'מגרשי ספורט'
            },
            'לינה': {
              'abandoned-buildings': 'מבנים נטושים',
              'abandoned-buildings-ground-floors': 'קומות קרקע'
              // 'points-700-abandoned': 'מבנים נטושים', //TODO
              // 'points-700-ground-floors': 'קומות קרקע' //TODO
            },
            'abandoned-buildings-resturants': 'נקודות חלוקת מזון',
            'שהייה': {
              'squares': 'כיכרות'
            },
            'סיוע_רפואי': {
              'community centers': 'מרכזים קהילתיים'
            }
            // '3d-route': 'מסלול',
            // '24h-homeless-route': '24שעות - מסלול'
          }
        }

        var individual_layers = [
          '3D',
          'city-border',
          'light-rail',
          'metro',
          'kibbutz-nadavot',
          'collecting-bottles', 
          'drug-deals',
          'formal',
          'stay-points-exist',
          'green areas and parks',
          'food-exist',
          'שהייה'
        ];

        var researchOn = true;
        var planningOn = false;
        var layers_map = map.getStyle().layers;

        function getLayerFromId(layerId) {
          for (i = 78; i < layers_map.length; i++) {
            if (layers_map[i].id == layerId)
              return layers_map[i];
          }
          return undefined;
        }

        function setLayerVis(current_layer, e) {
          const clickedLayer = current_layer.textContent;
          if (e != null) {
            e.preventDefault();
            e.stopPropagation();
          }
          
          const visibility = map.getLayoutProperty(
            clickedLayer,
            'visibility'
          );
          if (visibility == 'visible' && current_layer.checked == false) {
              map.setLayoutProperty(clickedLayer, 'visibility', 'none');
              this.className = '';
          } else {
            this.className = 'active';
            map.setLayoutProperty(
              clickedLayer,
              'visibility',
              'visible'
            );
          }
        }


        
        function addTitleToLegend(titleName) {
          if (titleName == "תכנון") {
            toCheck = false;
          }
          var line_div = document.createElement('div');
          line_div.className = 'accordion-body';
          line_div.id = 'title_' + titleName;
          const all_box = document.createElement('input');
          all_box.type = 'checkbox';
          all_box.checked = toCheck;
          all_box.id = titleName;
          all_box.href = '#';
          all_box.textContent = titleName;
          all_box.className = 'active';

          var startIdx = collapseOne.children.length;

          all_box.onchange = function (e) {
            var mainTitle = document.getElementById('main_title').children[0];
            var secondaryTitle = document.getElementById('secondary_title');
            var instructionTitle= document.getElementById('instruction');
            if (this.id == "מחקר") {
              researchOn = !researchOn;
              if (!planningOn) {
                mainTitle.innerHTML = 'כלי לקריאה מחודשת של תל-אביב מעיניהם של דרי הרחוב';
                secondaryTitle.style.display = 'block';
                instructionTitle.style.display = 'none';
              }
            }
            else if (this.id == "תכנון") {
              planningOn = !planningOn;
              mainTitle.innerHTML = 'פריסת מוקדים עירונית המאפשרת קיום חיים בסטטוס המעבר';
              secondaryTitle.style.display = 'none';
              instructionTitle.style.display = 'block';
              var vis = true;
              if (!planningOn && !researchOn) {
                vis = false;
              }
              if (!planningOn && researchOn) {
                mainTitle.innerHTML = 'כלי לקריאה מחודשת של תל-אביב מעיניהם של דרי הרחוב';
                secondaryTitle.style.display = 'block';
                instructionTitle.style.display = 'none';
              }
              for (i = 0; i < startIdx + 1; i++) {
                const current_layer = collapseOne.children[i].children[0];
                
                if (individual_layers.includes(current_layer.id)) {
                  current_layer.checked = vis;
                  if (current_layer.id.startsWith("subtitle_"))
                    continue;
                  setLayerVis(current_layer, e);
                }
              }
            }
            for (i = startIdx + 1; i < collapseOne.children.length; i++)
            {
              const current_layer = collapseOne.children[i].children[0];
              
              if (collapseOne.children[i].id.startsWith("title_"))
                break;
              if (current_layer.id == "3D")
                continue;
              if (this.checked == false) {
                if (!individual_layers.includes(current_layer.id) || (!researchOn && !planningOn))
                  current_layer.checked = false;
              } else {
                if (!individual_layers.includes(current_layer.id) || (researchOn || planningOn))
                  current_layer.checked = true;
              }
              if (!current_layer.id.startsWith("subtitle_") && current_layer.id != 'שהייה' && current_layer.id != 'עבודה')
                setLayerVis(current_layer, e);
              
            }
            
          };

          var all_title = document.createElement('span');
          all_title.innerHTML = titleName;
          all_title.style = "font-size:10.0pt; margin-left:10px;"

          line_div.appendChild(all_box);
          line_div.appendChild(all_title);
          if (titleName == "מחקר") {
            research.appendChild(line_div);
          }
          else {
            collapseOne.appendChild(line_div);
          }
          
        }

        var divNum = 3;

        function createSubTitle(subTitleName, titleName) {
          if (titleName == "תכנון") {
            toCheck = false;
          }
          var numStr = divNum.toString();
          divNum++;
          var accordionDiv = document.createElement('div');
          accordionDiv.className = 'accordion';
          accordionDiv.id = 'accordion' + numStr;
          var accordionItem = document.createElement('div');
          accordionItem.className = 'accordion-item';

          var accordionHead = document.createElement('h2');
          accordionHead.className = 'accordion-header';
          accordionHead.id = 'headingOne' + numStr;
          var accordionButton = document.createElement('button');
          accordionButton.className = 'accordion-button2 collapsed';
          accordionButton.type = 'button';
          accordionButton.dataset.bsToggle = 'collapse';
          accordionButton.dataset.bsTarget = '#' + subTitleName + '_' + titleName;
          accordionButton.ariaExpanded = 'true';
          accordionButton.ariaControls = subTitleName + '_' + titleName;
          accordionButton.onclick = function(){accordionClick();};
          // accordionButton.innerHTML = subTitleName;
          accordionHead.appendChild(accordionButton);
          var subTitleDiv = document.createElement('div');
          subTitleDiv.id = subTitleName + '_' + titleName;
          subTitleDiv.className = 'accordion-collapse collapse hide';
          subTitleDiv.setAttribute('aria-labelledby', accordionHead.id);
          if (titleName == 'מחקר') {
            subTitleDiv.dataset.parent = '#research';
          }
          else {
            subTitleDiv.dataset.parent = '#planning';
          }
          var subTitleCheckBox = addSubTitleToLegend(subTitleName, subTitleDiv);
          var buttonTitle = document.createElement('span');
          finalTitle = subTitleName.includes('_') ? subTitleName.replace("_", " ") : subTitleName;
          buttonTitle.innerHTML = finalTitle;
          buttonTitle.style.paddingInline = '10px';
          accordionButton.appendChild(subTitleCheckBox);
          accordionButton.appendChild(buttonTitle);
          accordionItem.appendChild(accordionHead);
          accordionItem.appendChild(subTitleDiv);
          accordionDiv.appendChild(accordionItem);
          var titleDiv = document.getElementById(titlesHebrew[titleName]);
          titleDiv.appendChild(accordionDiv);
          return subTitleDiv;
        }

        function addSubTitleToLegend(subTitleName, accordionItem) {
          // var line_div = document.createElement('div');
          // line_div.className = 'accordion-body';
          // line_div.id = 'subtitle_' + subTitleName;
          const all_box = document.createElement('input');
          all_box.type = 'checkbox';
          all_box.checked = toCheck;
          all_box.id = subTitleName + '_';
          all_box.href = '#';
          all_box.textContent = subTitleName;
          all_box.className = 'active';
          // all_box.style = "margin-left:10px;"

          // var startIdx = collapseOne.children.length;

          all_box.onchange = function (e) {
            for (i = 0; i < accordionItem.children.length; i++)
            {
              const current_layer = accordionItem.children[i].children[0];
              
              // if (accordionItem.children[i].id.startsWith("title_") || current_layer.style.marginLeft == "10px")
              //   break;
              if (this.checked == false) {
                current_layer.checked = false;
              } else {
                current_layer.checked = true;
              }
              const clickedLayer = current_layer.textContent;
              e.preventDefault();
              e.stopPropagation();
              
              const visibility = map.getLayoutProperty(
                clickedLayer,
                'visibility'
              );
              if (visibility == 'visible' && current_layer.checked == false) {
                  map.setLayoutProperty(clickedLayer, 'visibility', 'none');
                  this.className = '';
                } else {
                  this.className = 'active';
                  map.setLayoutProperty(
                    clickedLayer,
                    'visibility',
                    'visible'
                  );
                }
              
            }
            
          };

          // var all_title = document.createElement('span');
          // all_title.innerHTML = subTitleName;
          // all_title.style = "font-size:10.0pt; margin-left:10px;"
          return all_box;
          // line_div.appendChild(all_box);
          // line_div.appendChild(all_title);
          // collapseOne.appendChild(line_div);
        }

        function addLayerToLegend(layerId, hebrewName, accordionDiv, isSub) {
          var layerObj = getLayerFromId(layerId);
          var layer = layerObj.id;
          layers.push(layer);
          var color = getLayerColor(layerObj);
          var layerType = layerObj.type;
          var item = document.createElement('div');
          item.id = 'item_' + layerObj.id;
          item.className = 'accordion-body';
          var key = document.createElement('span');
          key.className = 'legend-key';
          if (Array.isArray(color)) {
            if (color.length == 3) {
              key.style.background = 'linear-gradient(90deg, ' + color[0] + ', ' + color[0] + ' 20%, transparent 20%, transparent 40%, ' 
                                                                                            + color[1] + ' 40%, ' + color[1]
                                                                                            + ' 60%, transparent 60%, transparent 80%, '
                                                                                            + color[0] + ' 80%)';
            }
            else {
              key.style.background = 'linear-gradient(90deg, ' + color[0]+ ', ' + color[0] + ' 49%, white, ' + color[1] + ' 51%)';
            }
          }
          else {
            key.style.backgroundColor = color;
          }
          if (layerType == 'circle') {
            key.style.borderRadius = '50%';
          }
          else if (layerType == 'line') {
            key.style.height = '2px';
            key.style.verticalAlign = 'middle';
          }
          const link = document.createElement('input');
          link.type = 'checkbox';
          link.id = layerObj.id;
          link.href = '#';
          link.textContent = layerObj.id;
          if (isSub)
            link.style = "margin-left:10px;";

          link.checked = toCheck;
          link.className = 'active';

          var vis = 'visible';
          if (layerObj.id == '3D' || !toCheck) {
            vis = 'none';
            link.checked = false;
          }
            
          map.setLayoutProperty(
            link.textContent,
            'visibility',
            vis
          );
          
          // Show or hide layer when the toggle is clicked.
          link.onchange = function (e) {
            const clickedLayer = this.textContent;
            e.preventDefault();
            e.stopPropagation();
            
            const visibility = map.getLayoutProperty(
              clickedLayer,
              'visibility'
            );
            
            // Toggle layer visibility by changing the layout object's visibility property.
            if (visibility == 'visible' && link.checked == false) {
              map.setLayoutProperty(clickedLayer, 'visibility', 'none');
              this.className = '';
            } else {
              this.className = 'active';
              map.setLayoutProperty(
                clickedLayer,
                'visibility',
                'visible'
              );
            }
          };

          var value = document.createElement('span');
          value.innerHTML = hebrewName;
          value.style = "font-size:10.0pt;"

          item.appendChild(link);
          item.appendChild(key);
          item.appendChild(value);
          accordionDiv.appendChild(item);
        }

        for (titleName in layers_for_legend) {

          // addTitleToLegend(titleName);
          for (subTitle in layers_for_legend[titleName]) {
            if (typeof layers_for_legend[titleName][subTitle] === "object") {
              var subTitleDiv = createSubTitle(subTitle, titleName);
              for (obj in layers_for_legend[titleName][subTitle]) {
                addLayerToLegend(obj, layers_for_legend[titleName][subTitle][obj], subTitleDiv, true);
              }
            }
            else {
              var accordionDiv = titleName == 'מחקר' ? document.getElementById('research') : document.getElementById('planning');
              addLayerToLegend(subTitle, layers_for_legend[titleName][subTitle], accordionDiv, false);
            }
          }
        }

        layers.push('3d-route');
        layers.push('24h-homeless-route');

        var route_layers = [
          '3D',
          'city-border',
          'light-rail',
          'metro',
          'עבודה_',
          'green areas and parks'
        ]

        function turnOffAllLayers() {
          
          var research_checkbox = document.getElementById('מחקר');
          var planning_checkbox = document.getElementById('תכנון');
          if (research_checkbox.checked == true) {
            research_checkbox.checked = false;
            var evt = document.createEvent("HTMLEvents");
            evt.initEvent("change", false, true);
            research_checkbox.dispatchEvent(evt);
          }
          if (planning_checkbox.checked == true) {
            planning_checkbox.checked = false;
            var evt = document.createEvent("HTMLEvents");
            evt.initEvent("change", false, true);
            planning_checkbox.dispatchEvent(evt);
          }
          for (i = 0; i < route_layers.length; i++) {
            var idx = i;
            var current_box = document.getElementById(route_layers[i]);
            current_box.checked = true;
            var evt = document.createEvent("HTMLEvents");
            evt.initEvent("change", false, true);
            current_box.dispatchEvent(evt);
            i = idx;
          }
        }

        // class HelloWorldControl {
        //   onAdd(map) {
        //   this._map = map;
        //   this._container = document.createElement('div');
        //   this._container.className = 'mapboxgl-ctrl';
        //   this._container.textContent = 'Hello, world';
        //   return this._container;
        //   }
          
        //   onRemove() {
        //   this._container.parentNode.removeChild(this._container);
        //   this._map = undefined;
        //   }
        // }

        // const myControl = new HelloWorldControl();
        // map.addControl(myControl, 'top-right');
        
        

        class MapboxGLButtonControl {
          constructor({
            className = "",
            title = "",
            eventHandler = evtHndlr
          }) {
            this._className = className;
            this._title = title;
            this._eventHandler = eventHandler;
          }

          onAdd(map) {
            this._btn = document.createElement("button");
            this._btn.className = "mapboxgl-ctrl-icon" + " " + this._className;
            this._btn.type = "button";
            this._btn.title = this._title;
            this._btn.onclick = this._eventHandler;

            this._container = document.createElement("div");
            this._container.className = "mapboxgl-ctrl-group mapboxgl-ctrl";
            this._container.appendChild(this._btn);

            return this._container;
          }

          onRemove() {
            this._container.parentNode.removeChild(this._container);
            this._map = undefined;
          }
        }
        
        routeIdsForPopup = {
          12145: ['לינה', '-', 'הקצאה'],
          2510: ['התרעננות | שירותים', '-', 'הקצאה'],
          15009: ['שהייה', '-', 'טיפול מרחבי'],
          43202: ['שהייה', '-', 'טיפול נופי'],
          2615: ['מזון', 'חומוס גרגר הזהב | שוק לוינסקי', 'הסבה'],
          19306: ['התרעננות', 'בית ספר קלישר', 'תוספת'],
          13479: ['לינה, מזון ותמיכה', 'מבנה נטוש | נחלת בנימין 2', 'הסבה'],
          25250: ['סיוע רפואי', 'מרכז קהילתי אריק אינשטיין', 'תוספת']
        }

        function addPopupToRoute() {
          map.moveLayer('24h-homeless-route', '3D');
          map.moveLayer('3d-route', '3D');
          const features = map.queryRenderedFeatures({layers: ['3d-route']});
          for (i = 0; i < features.length; i++) {
            
            var feature = features[i];
            var fId = feature.properties['idbinyan'];

            if (fId in routeIdsForPopup) {
              var height = feature.properties['govasimple'];
              
              var offset = -height - 50;
              if (fId == 2615 || fId == 19306 || fId == 15009) {
                offset -= 50;
              }
              var popup = new mapboxgl.Popup({ offset: [0, offset], closeOnMove: false, closeButton: false, closeOnClick: false, className: "routePopup" });
              var title = routeIdsForPopup[fId][0];
              var subtitle = routeIdsForPopup[fId][1];
              var finaltitle = routeIdsForPopup[fId][2];
              var htmlText = "";
              if (fId == 19306) {
                htmlText = '<div id="popupButton" class="routePopup" onclick=openImage("01")>' +
                            '<h3><b>' +
                            title +
                            '</b></h3>' +
                            '<h3 class="h3_1"><b>' +
                            subtitle +
                            '</b></h3>' +
                            '<h3 class="h3_1"><b>' +
                            finaltitle +
                            '</b></h3></div>';
              }
              else if (fId == 13479) {
                htmlText = '<div id="popupButton" class="routePopup" onclick=openImage("01_Building_Photo")>' +
                            '<h3><b>' +
                            title +
                            '</b></h3>' +
                            '<h3 class="h3_1"><b>' +
                            subtitle +
                            '</b></h3>' +
                            '<h3 class="h3_1"><b>' +
                            finaltitle +
                            '</b></h3></div>';
              }
              else {
                htmlText ='<div id="popupButton" class="routePopup"<h3><b>' +
                          title +
                          '</b></h3>' +
                          '<h3 class="h3_1"><b>' +
                          subtitle +
                          '</b></h3>' +
                          '<h3 class="h3_1"><b>' +
                          finaltitle +
                          '</b></h3></div>';
              }
              popup.setMaxWidth('240px');
              var coordinates = feature.geometry.coordinates.slice();
              
              coordinates = new L.Polygon(coordinates).getBounds().getCenter();
              popup.setLngLat([coordinates['lat'], coordinates['lng']])
              .setHTML(htmlText)
              .addTo(map);
              routePopups.push(popup);
            }
          }
        }

        function routeHandler(event) {
          turnOffAllLayers();
          // $(".accordion-collapse").collapse("hide");
          // Turn ON route layers
          setRouteVis('visible');
          setTitlesVis("none");
          
          center_pos = [34.771146978793695, 32.0639430515279];
          formToOpen = -1;
          flyToFunc(center_pos, 15.6, 62, -45, false);
          isRouteOn = true;
          // addPopupToRoute();

        }

        const ctrlLine = new MapboxGLButtonControl({
          className: "mapbox-gl-draw_line",
          title: "לחץ לליווי דר רחוב ביומו בפריסה העירונית",
          eventHandler: routeHandler
        });

        map.addControl(ctrlLine, 'top-right');


        // var line_div = document.createElement('div');
        // line_div.className = 'accordion-body';
        // const all_box = document.createElement('input');
        // all_box.type = 'checkbox';
        // all_box.checked = true;
        // all_box.id = 'all_box';
        // all_box.href = '#';
        // all_box.textContent = 'all_box';
        // all_box.className = 'active';

        // all_box.onchange = function (e) {
        //   for (i = 1; i < collapseOne.children.length; i++)
        //   {
        //     const current_layer = collapseOne.children[i].children[0];
        //     if (this.checked == false) {
        //       current_layer.checked = false;
        //     } else {
        //       current_layer.checked = true;
        //     }
        //     const clickedLayer = current_layer.textContent;
        //     e.preventDefault();
        //     e.stopPropagation();
            
        //     const visibility = map.getLayoutProperty(
        //       clickedLayer,
        //       'visibility'
        //     );
        //     if (visibility == 'visible' && current_layer.checked == false) {
        //         map.setLayoutProperty(clickedLayer, 'visibility', 'none');
        //         this.className = '';
        //       } else {
        //         this.className = 'active';
        //         map.setLayoutProperty(
        //           clickedLayer,
        //           'visibility',
        //           'visible'
        //         );
        //       }
            
        //   }
          
        // };

        // var all_title = document.createElement('span');
        // all_title.innerHTML = 'כל השכבות';
        // all_title.style = "font-size:10.0pt; margin-left:10px;"

        // line_div.appendChild(all_box);
        // line_div.appendChild(all_title);
        // collapseOne.appendChild(line_div);

        function getLayerColor(layer) {
          // console.log(layer);
          switch (layer.type) {
            case "line":
              var lineColor = "hsl(0, 100%, 0%)";
              if ("paint" in layer) {
                if ("line-color" in layer.paint) {
                  var lineColor = layer.paint["line-color"];
                  if (Array.isArray(lineColor)) {
                    var innerLineColor = lineColor[6];
                    if (Array.isArray(innerLineColor)) {
                      if ('line-dasharray' in layer.paint) {
                        return [innerLineColor[3], innerLineColor[4], "true"];
                      }
                      return [innerLineColor[3], innerLineColor[4]];
                    }
                    return innerLineColor;
                  }
                    
                }
              }
              return lineColor;
            case "fill":
              var fillColor = "hsl(0, 100%, 0%)";
              var fillPaint = layer.paint;
              if ("fill-color" in fillPaint) {
                fillColor = fillPaint["fill-color"];
              }
              else if ("fill-outline-color" in fillPaint) {
                fillColor = fillPaint["fill-outline-color"];
              }
              if (Array.isArray(fillColor)) {
                var innerFillColor = fillColor[6];
                if (Array.isArray(innerFillColor))
                  return [innerFillColor[3], innerFillColor[4]];
                return innerFillColor;
              }
              return fillColor;
            case "circle":
              var circleColor = "hsl(0, 100%, 0%)";
              if ("paint" in layer) {
                var circlePaint = layer.paint;
                if ("circle-color" in circlePaint) {
                  circleColor = circlePaint["circle-color"];
                  if (Array.isArray(circleColor))
                    return circleColor[5];
                }
                else if ("circle-stroke-color" in circlePaint){
                  circleColor = circlePaint["circle-stroke-color"];
                }
                if (Array.isArray(circleColor))
                  circleColor = circleColor[6];
              }
              return circleColor;
              
            case "fill-extrusion":
              return layer.paint["fill-extrusion-color"];
          }
        }

        var notInLegend = [
          'back-yard-stroke',
          'front-yard-stroke'
        ];

        var layerHebrewNames = {
          'sleeping-corners': 'מרחבי לינה',
          'informal': 'הזדמנויות',
          'formal': 'מענים מוסדיים',
          'city-border': 'גבול העיר',
          'green areas and parks': 'גינות',
          'front yard and back yard': 'חצר קדמית ואחורית',
          'back-yard': 'חצר אחורית',
          'parking': 'חניונים',
          'business': 'חנויות',
          'light-rail': 'תוואי הרכבת הקלה',
          '3D': '3D',
          'strategic axes': 'צירים אסטרטגיים',
          'squares': 'כיכרות',
          'beaches-wardrobes': 'מלתחות חוף',
          'mikvahs': 'מקוואות',
          'sport': 'מגרשי ספורט',
          'community centers': 'מרכזים קהילתיים',
          'metro': 'מטרו',
          'abandoned-buildings-sleeping': 'מבנים נטושים - שינה',
          'abandoned-buildings-resturants': 'מבנים נטושים - מסעדות',
          '3d-route': 'מסלול',
          '24h-homeless-route': '24 מסלול',
          'abandoned-buildings': 'מבנים נטושים',
          'abandoned-buildings-ground-floors': 'קומות קרקע'
        }

        // create legend
        


        // for (i = 78; i < layers_map.length; i++) {
        //   if (!notInLegend.includes(layers_map[i].id)) {
        //     layers.push(layers_map[i].id);
        //     var layer = layers_map[i].id;
        //     var color = getLayerColor(layers_map[i]);
        //     var layerType = layers_map[i].type;
        //     var item = document.createElement('div');
        //     item.id = 'item_' + layers_map[i].id;
        //     item.className = 'accordion-body';
        //     var key = document.createElement('span');
        //     key.className = 'legend-key';
        //     key.style.backgroundColor = color;
        //     if (layerType == 'circle') {
        //       key.style.borderRadius = '50%';
        //     }
        //     else if (layerType == 'line') {
        //       key.style.height = '2px';
        //       key.style.verticalAlign = 'middle';
        //     }
              
        //     const link = document.createElement('input');
        //     link.type = 'checkbox';
        //     link.id = layers_map[i].id;
        //     link.href = '#';
        //     link.textContent = layers_map[i].id;
        //     link.style = "margin-left:10px;"

        //     link.checked = true;
        //     link.className = 'active';

        //     var vis = 'visible';
        //     if (layers_map[i].id == '3D') {
        //       vis = 'none';
        //       link.checked = false;
        //     }
              
        //     map.setLayoutProperty(
        //       link.textContent,
        //       'visibility',
        //       vis
        //     );
            
        //     // Show or hide layer when the toggle is clicked.
        //     link.onchange = function (e) {
        //       const clickedLayer = this.textContent;
        //       e.preventDefault();
        //       e.stopPropagation();
              
        //       const visibility = map.getLayoutProperty(
        //         clickedLayer,
        //         'visibility'
        //       );
              
        //       // Toggle layer visibility by changing the layout object's visibility property.
        //       if (visibility == 'visible' && link.checked == false) {
        //         map.setLayoutProperty(clickedLayer, 'visibility', 'none');
        //         this.className = '';
        //       } else {
        //         this.className = 'active';
        //         map.setLayoutProperty(
        //           clickedLayer,
        //           'visibility',
        //           'visible'
        //         );
        //       }
        //     };

        //     var value = document.createElement('span');
        //     value.innerHTML = layerHebrewNames[layer];
        //     value.style = "font-size:10.0pt;"

        //     item.appendChild(link);
        //     item.appendChild(key);
        //     item.appendChild(value);
        //     collapseOne.appendChild(item);
        //   }
        // }

        map.on('moveend', function(e){
          if(flying) {
            openForm(formToOpen);
            if (map.getLayoutProperty('3d-route', 'visibility') == 'visible')
              addPopupToRoute();
            else if (isRouteOn) {
              for (i = 0; i < collapseOne.children.length; i++) {
                var currentTitle = collapseOne.children[i];
                var current_box = currentTitle.children[0];
                if (currentTitle.id == 'title_תכנון') {
                    current_box.checked = true;
                    var evt = document.createEvent("HTMLEvents");
                    evt.initEvent("change", false, true);
                    current_box.dispatchEvent(evt);
                }
              }
              isRouteOn = false;
            }
            map.fire('flyend');
          }
        });
        
        map.on('flystart', function(){
          flying = true;
        });
        map.on('flyend', function(){
          flying = false;
        });

        function flyToFunc(pos, zoomLevel, pitchLevel, bearingLevel, is3D) {
          closeForm();
          for (i = 0; i < collapseOne.children.length; i++) {
            if (collapseOne.children[i].innerText == '3D' && is3D) {
              collapseOne.children[i].children[0].checked = true;
            }
            map.setLayoutProperty(
              '3D',
              'visibility',
              'visible'
            );
            
          }
          map.flyTo({
            center: pos,
            zoom: zoomLevel,
            bearing: bearingLevel,
            pitch: pitchLevel,
            
            speed: 0.3, 
            curve: 1, 
            
            easing: (t) => t,
            
            essential: true
          });
          map.fire('flystart');
        }



        function updateTextDiv(divId, properties, text="") {

          var textForm = document.getElementById(divId).querySelector('#text_form');
          if (textForm != undefined) {
            if (text == "") {
              var name = document.createElement('h3');
              name.innerHTML = 'שם<br><b>' +
                                properties["name_he"] +
                                '</b></br>';
              var sleeping = document.createElement('h3');
              sleeping.innerHTML = 'מרחב לינה<br><b>' +
                                properties["sleeping corner"] +
                                '</b></br>';
              var description = document.createElement('h3');
              description.innerHTML = '<b>' + properties["description"] + '</b>';
              if (textForm.children.length > 0) {
                textForm.replaceChild(name, textForm.children[0]);
                textForm.replaceChild(sleeping, textForm.children[1]);
                textForm.replaceChild(description, textForm.children[2]);
              }
              else {
                textForm.appendChild(name);
                textForm.appendChild(sleeping);
                textForm.appendChild(description);
              }
            }
            else {
              var title = document.createElement('h3');
              title.innerHTML = text;
              if (textForm.children.length > 0) {
                textForm.replaceChild(title, textForm.children[0]);
              }
              else {
                textForm.appendChild(title);
              }
            }
          }
        }
        
        map.on('click', (e) => {
          console.log(e.lngLat);
          console.log("Center:\n");
          console.log(map.getCenter());
        });

        for (i = 0; i < layers.length; i++) {
          map.on('click', layers[i], (e) => {
            // console.log(e.features[0].layer['id']);
            var prop = e.features[0].properties["name"];
            var idsToPrint = ['3D', '3d route'];
            if (idsToPrint.includes(e.features[0].layer['id'])) {
              console.log(e.features[0].properties);
            }
            // console.log(prop);
            if (prop in formIdx) {
              if (e.features[0].layer['id'] == 'sleeping-corners') {
                updateTextDiv(forms[formIdx[prop]], e.features[0].properties);
              }
              else if (prop == 'Pasta Basta') {
                updateTextDiv(forms[formIdx[prop]], e.features[0].properties, "מנהל בסטה בשוק הכרמל");
              }
              else if (prop == 'dizengoff Bottles') {
                updateTextDiv(forms[formIdx[prop]], e.features[0].properties, "ציר אסטרטגי - איסוף בקבוקים");
              }
              if (prop == "Dizengoff  Square" || (prop == "market" && e.features[0].layer['id'] == 'food-exist')) {
                flyToFunc(e.features[0].geometry.coordinates, 16, 60, 0, true);
                formToOpen = formIdx[prop];
              }
              else if (!(prop == 'market')) {
                openForm(formIdx[prop]);
              }
            }
            else if (e.features[0].layer['id'] == 'sleeping-corners') {
              updateTextDiv('only_text', e.features[0].properties);
              openForm(formIdx['only_text']);
            }
          });
  
          map.on('mouseenter', layers[i], () => {
            map.getCanvas().style.cursor = 'pointer';
          });
          
          map.on('mouseleave', layers[i], () => {
            map.getCanvas().style.cursor = '';
          });
        }

        function removeMapLayer(layerId) {
          for (i = 0; i < collapseOne.children.length; i++) {
            if (collapseOne.children[i].children[0].id == layerId) {
              collapseOne.children[i].remove();
              map.getLayer(layerId).visibility = 'none';
            }
          }
        }
        
      // Remove when needed!!!
      // removeMapLayer('night-policy-in-leisure-areas');

      var noPopupLayers = [
        '3D',
        'back-yard',
        'front-yard',
        'business',
        'parking',
        'green-areas-and-parks',
        '3d-route',
        '24h-homeless-route'
      ];

      function hoverPopupMove(popup) {
        map.on('mousemove', function (e) {
            var features = map.queryRenderedFeatures(e.point, {
              layers: layers
            });
            if (!features.length) {
              return;
            }
            var feature = features[0];
            if (feature.layer.id == '3d-route')
              console.log(feature);
            // +
            //                   '<p>'  +
            //                   layerHebrewNames[feature.layer.id] +
            //                   '</p>';
            if (!(noPopupLayers.includes(feature.layer.id))) {
              var title = feature.properties["name_he"] != undefined ? feature.properties["name_he"] : layerHebrewNames[feature.layer.id];
              var htmlText = '<h3 class="h3_1"><b>' +
                              title +
                              '</b></h3>';
              if (feature.layer.id == 'sleeping-corners') {
                htmlText =  '<h3 class="h3_2">שם' + 
                            '<br><b>' +
                            feature.properties["name_he"] +
                            '</b></br></h3>' +
                            '<h3 class="h3_2">מרחב לינה' + 
                            '<br><b>' +
                            feature.properties["sleeping corner"] +
                            '</b></br></h3>' +
                            '<h3 class="h3_1"><b>' +
                            feature.properties["description"] +
                            '</b></h3>';
                popup.setMaxWidth('240px');
              }
              else if (feature.layer.id == 'strategic-axes' && "tsug" in feature.properties) {
                htmlText =  '<h3><b>' +
                            feature.properties["name_he"] +
                            '</b></h3>' +
                            '<h3 class="h3_2">שעות פעילות' + 
                            '<br><b>' +
                            feature.properties["tsug"] +
                            '</b></br></h3>';
                popup.setMaxWidth('240px');
              }
              popup.setLngLat(e.lngLat)
              .setHTML(htmlText)
              .addTo(map);
            }
            else {
              popup.remove();
            }
        });
        map.on('mouseleave', function(e) {
          popup.remove();
        });
      }
      
      var popup = new mapboxgl.Popup({ offset: [0, -15], closeOnMove: true, closeButton: false });
      hoverPopupMove(popup);

      

      });
    </script>
  </body>
</html>